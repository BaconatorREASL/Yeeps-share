<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    // --- 1. SETUP FIREBASE ---
    // PASTE THE CONFIG FROM THE FIREBASE CONSOLE BELOW THIS LINE:
    // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDgsr50jIKTUyK6V4PcjjVpRKfvuG3sYd8",
  authDomain: "yeeps-sharee.firebaseapp.com",
  projectId: "yeeps-sharee",
  storageBucket: "yeeps-sharee.firebasestorage.app",
  messagingSenderId: "1065169328522",
  appId: "1:1065169328522:web:6d3b18ba2c990e83f51073",
  measurementId: "G-Z2CDN9SFPQ"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

    // --- 2. EXISTING SETUP ---
    const ADMIN_NAME = "DatWeirdFNFfan";
    const currentUser = localStorage.getItem('current_yeep_user');
    
    // We still keep Roles/Bans local for now to keep it simple for you
    const rolesDB = JSON.parse(localStorage.getItem('yeeps_roles_db')) || {};
    const usersDB = JSON.parse(localStorage.getItem('yeeps_users_db')) || {};
    const statusDB = JSON.parse(localStorage.getItem('yeeps_status_db')) || {};

    // Security Check
    if (currentUser && statusDB[currentUser]) {
        const s = statusDB[currentUser];
        if (s.type === "ban_perm" || (s.expires && s.expires > Date.now())) {
            window.location.href = "ban.html";
        }
    }
    if (!currentUser) window.location.href = "login.html";

    const myRoles = (currentUser === ADMIN_NAME) ? ["owner"] : (rolesDB[currentUser] || []);
    const isOwner = currentUser === ADMIN_NAME;
    const isStaff = myRoles.some(r => ["owner", "dev", "webmod", "gamemod"].includes(r));
    const maxChars = 280;

    if(isStaff) document.getElementById('staffPanel').style.display = "block";
    if(isOwner) document.getElementById('ownerOnly').style.display = "block";

    // --- 3. SUBMIT POST (CLOUDY VERSION) ---
    function submitPost() {
        const c = document.getElementById('postContent').value.trim();
        const m = document.getElementById('mediaUrl').value.trim();
        
        if(!c && !m) return;
        
        // This sends data to Google's servers instead of your browser cache
        db.collection("posts").add({
            username: currentUser,
            content: c,
            media: m,
            likes: [],
            featured: false,
            timestamp: firebase.firestore.FieldValue.serverTimestamp() // Real server time
        }).then(() => {
            // Clear the box after posting
            document.getElementById('postContent').value = "";
            document.getElementById('mediaUrl').value = "";
        }).catch((error) => {
            console.error("Error writing document: ", error);
            alert("Error posting: " + error.message);
        });
    }

    // --- 4. LOAD FEED (REAL TIME VERSION) ---
    function loadFeed() {
        const feed = document.getElementById('feed');
        const featZone = document.getElementById('featured-zone');
        
        // This listens for updates instantly!
        db.collection("posts").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
            feed.innerHTML = "";
            featZone.innerHTML = "";

            snapshot.forEach((doc) => {
                const p = doc.data();
                const postId = doc.id; // The unique ID from Firebase

                let uRoles = (p.username === ADMIN_NAME) ? ["owner"] : (rolesDB[p.username] || []);
                let mainColor = uRoles.length > 0 ? `role-${uRoles[0]}` : "";
                let icons = uRoles.map(r => `<img src="Images/roles/${r}.png" class="inline-icon">`).join('');
                let pfp = usersDB[p.username]?.pfp || "https://ui-avatars.com/api/?name=" + p.username;
                let liked = p.likes && p.likes.includes(currentUser);

                const div = document.createElement('div');
                div.className = `post ${p.featured ? 'pinned' : ''}`;
                
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <div style="display:flex; gap:10px;">
                            <img src="${pfp}" class="pfp-img" onclick="location.href='pages/user-profile.html?u=${p.username}'">
                            <div>
                                <strong class="${mainColor}" onclick="location.href='pages/user-profile.html?u=${p.username}'">${p.username}</strong>
                                ${icons}
                            </div>
                        </div>
                        <div>
                            ${isOwner ? `<span onclick="toggleFeature('${postId}', ${p.featured})" style="cursor:pointer;">‚≠ê</span>` : ''}
                            ${(isStaff || p.username === currentUser) ? `<span onclick="deletePost('${postId}')" style="cursor:pointer; color:red;">üóëÔ∏è</span>` : ''}
                        </div>
                    </div>
                    <p style="white-space: pre-wrap;">${p.content}</p>
                    ${renderMedia(p.media)}
                    <div style="margin-top:10px;">
                        <span onclick="likePost('${postId}')" style="cursor:pointer; color:${liked ? 'orange':'gray'}">‚ù§Ô∏è ${p.likes ? p.likes.length : 0}</span>
                    </div>
                `;
                
                if(p.featured || (p.likes && p.likes.length >= 5)) {
                    featZone.appendChild(div);
                } else {
                    feed.appendChild(div);
                }
            });
        });
    }

    // --- 5. CLOUD ACTIONS ---
    function likePost(id) {
        const postRef = db.collection("posts").doc(id);
        
        // We have to use a "Transaction" to safely update likes on a server
        db.runTransaction((transaction) => {
            return transaction.get(postRef).then((postDoc) => {
                if (!postDoc.exists) return;
                let data = postDoc.data();
                let likes = data.likes || [];
                
                if (likes.includes(currentUser)) {
                    likes = likes.filter(u => u !== currentUser);
                } else {
                    likes.push(currentUser);
                }
                transaction.update(postRef, { likes: likes });
            });
        });
    }

    function deletePost(id) {
        if(confirm("Delete this?")) {
            db.collection("posts").doc(id).delete();
        }
    }

    function toggleFeature(id, currentStatus) {
        if(!isOwner) return;
        db.collection("posts").doc(id).update({
            featured: !currentStatus
        });
    }

    // Helper for media (Same as before)
    function renderMedia(url) {
        if(!url) return "";
        if(url.includes("youtube.com") || url.includes("youtu.be")) {
            let id = url.includes("v=") ? url.split("v=")[1].split("&")[0] : url.split("/").pop();
            return `<iframe width="100%" height="250" src="https://www.youtube.com/embed/${id}" frameborder="0" style="border-radius:10px; margin-top:10px;"></iframe>`;
        }
        return `<img src="${url}" style="width:100%; border-radius:10px; margin-top:10px;" onerror="this.style.display='none'">`;
    }
    
    // Start the feed!
    loadFeed();
    
    // MODERATION (STILL LOCAL FOR NOW)
    function applyMod() {
        // ... (Keep your existing applyMod code here if you want local bans to still work)
        alert("Note: Bans are currently only saving on your computer, not the server yet!");
    }
    function manageRole(type) {
        // ... (Keep existing manageRole code)
        alert("Note: Roles are currently only saving on your computer!");
    }
</script>
